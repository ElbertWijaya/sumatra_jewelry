generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model AppUser {
  id        String   @id @default(uuid())
  email     String   @unique
  fullName  String
  jobRole   TaskJobRole? @map("job_role")
  password  String
  createdAt DateTime @default(now())
  ordersCreated Order[] @relation("OrdersCreated")
  ordersUpdated Order[] @relation("OrdersUpdated")
  histories OrderHistory[]
  tasksAssigned OrderTask[] @relation("TaskAssignedTo")
  tasksValidated OrderTask[] @relation("TaskValidatedBy")
  tasksChecked  OrderTask[]
  inventoryCreated InventoryItem[] @relation("InventoryItemCreatedBy")
  inventoryUpdated InventoryItem[] @relation("InventoryItemUpdatedBy")
}

model Order {
  id           Int       @id @default(autoincrement()) @map("id")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  code         String?   @unique @map("code")
  customerName String    @map("customer_name")
  customerAddress String? @map("customer_address")
  customerPhone String?  @map("customer_phone")
  jenisBarang   String   @map("item_type") // previously 'jenis'
  jenisEmas     String   @map("gold_type")
  warnaEmas     String   @map("gold_color")
  hargaEmasPerGram Decimal? @db.Decimal(14,2) @map("gold_price_per_gram")
  hargaPerkiraan  Decimal? @db.Decimal(14,2) @map("estimated_price")
  hargaAkhir      Decimal? @db.Decimal(14,2) @map("final_price")
  dp            Decimal?  @db.Decimal(14,2) @map("down_payment")
  promisedReadyDate DateTime? @map("promised_ready_date")
  tanggalSelesai  DateTime? @map("completed_date")
  tanggalAmbil    DateTime? @map("pickup_date")
  catatan       String?  @map("notes")
  fotoDesainUrl String?  @map("design_image_url")
  referensiGambarUrls Json?   @map("reference_image_urls") // array of strings
  stoneCount    Int      @default(0) @map("stone_count")
  totalBerat    Decimal? @db.Decimal(10,2) @map("total_stone_weight")
  status        OrderStatus @default(DRAFT) @map("status")
  createdById   String? @map("created_by_id")
  updatedById   String? @map("updated_by_id")
  createdBy    AppUser? @relation("OrdersCreated", fields: [createdById], references: [id])
  updatedBy    AppUser? @relation("OrdersUpdated", fields: [updatedById], references: [id])
  histories    OrderHistory[]
  stones       OrderStone[]
  tasks        OrderTask[]
  inventoryItems InventoryItem[]
}

model OrderStone {
  id       Int    @id @default(autoincrement())
  order    Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId  Int
  bentuk   String
  jumlah   Int
  berat    Decimal? @db.Decimal(10,2)
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([bentuk])
}

model OrderHistory {
  id         Int      @id @default(autoincrement())
  order      Order    @relation(fields: [orderId], references: [id])
  orderId    Int
  changedAt  DateTime @default(now())
  user       AppUser? @relation(fields: [userId], references: [id])
  userId     String?
  changeSummary String?
  diff       Json?
}

model OrderTask {
  id            Int       @id @default(autoincrement())
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId       Int
  stage         String?   @map("stage")
  status        TaskStatus @default(OPEN) @map("status")
  assignedTo    AppUser?  @relation("TaskAssignedTo", fields: [assignedToId], references: [id])
  assignedToId  String?   @map("assigned_to_id")
  jobRole       TaskJobRole? @map("job_role")
  requestedDoneAt DateTime? @map("requested_done_at")
  validatedBy   AppUser?  @relation("TaskValidatedBy", fields: [validatedById], references: [id])
  validatedById String?   @map("validated_by_id")
  validatedAt   DateTime? @map("validated_at")
  notes         String?   @map("notes")
  // Progress check by assignee
  isChecked     Boolean   @default(false) @map("is_checked")
  checkedAt     DateTime? @map("checked_at")
  checkedBy     AppUser?  @relation(fields: [checkedById], references: [id])
  checkedById   String?   @map("checked_by_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([orderId])
  @@index([assignedToId])
}

model InventoryItem {
  id           Int       @id @default(autoincrement())
  order        Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)
  orderId      Int?
  code         String?   @map("code")
  name         String?   @map("name")
  category     String?   @map("category")
  material     String?   @map("material")
  karat        String?   @map("karat")
  goldType     String?   @map("gold_type")
  goldColor    String?   @map("gold_color")
  weightGross  Decimal?  @db.Decimal(10,2) @map("weight_gross")
  weightNet    Decimal?  @db.Decimal(10,2) @map("weight_net")
  stoneCount   Int?      @map("stone_count")
  stoneWeight  Decimal?  @db.Decimal(10,2) @map("stone_weight")
  size         String?   @map("size")
  dimensions   String?   @map("dimensions")
  barcode      String?   @unique @map("barcode")
  sku          String?   @unique @map("sku")
  location     String?   @map("location")
  cost         Decimal?  @db.Decimal(14,2) @map("cost")
  price        Decimal?  @db.Decimal(14,2) @map("price")
  status       String?   @map("status")
  images       Json?     @map("images")
  notes        String?   @map("notes")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  createdBy    AppUser?  @relation("InventoryItemCreatedBy", fields: [createdById], references: [id])
  createdById  String?   @map("created_by_id")
  updatedBy    AppUser?  @relation("InventoryItemUpdatedBy", fields: [updatedById], references: [id])
  updatedById  String?   @map("updated_by_id")

  @@index([orderId])
  @@index([barcode])
  @@index([sku])
}

enum TaskStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  AWAITING_VALIDATION
  DONE
  CANCELLED
}

enum TaskJobRole {
  ADMINISTRATOR
  SALES
  DESIGNER
  CASTER
  CARVER
  DIAMOND_SETTER
  FINISHER
  INVENTORY
}


enum OrderStatus {
  DRAFT
  DITERIMA
  DALAM_PROSES
  SIAP
  DIAMBIL
  BATAL
}

/// After migration, run a script to backfill the code field: TM-YYYYMM-XXXX
